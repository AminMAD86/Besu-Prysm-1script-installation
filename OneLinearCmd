#!/bin/bash
# Ethereum Sepolia Node - Full Setup (stream extract, clean output)

# Don't exit on error immediately - let us handle it gracefully
set +e

ETHEREUM_DIR="/root/ethereum"
EXECUTION_DIR="$ETHEREUM_DIR/execution"
CONSENSUS_DIR="$ETHEREUM_DIR/consensus"
JWT_FILE="$ETHEREUM_DIR/jwt.hex"
DOCKER_COMPOSE_FILE="$ETHEREUM_DIR/docker-compose.yml"
BESU_SNAPSHOT_URL="https://snapshots.ethpandaops.io/sepolia/besu/9540000/snapshot.tar.zst"
PRYSM_SNAPSHOT_URL="https://snapshots.publicnode.com/ethereum-sepolia-prysm-8865077.tar.lz4"

echo ""
echo "=========================================="
echo " Ethereum Sepolia Node - Setup Started"
echo "=========================================="
echo ""

# 1️⃣ Check prerequisites
echo "→ Checking prerequisites..."
if ! command -v zstd &> /dev/null; then
    echo "⚠️  zstd not found. Installing..."
    apt-get update -qq >/dev/null 2>&1
    apt-get install -y zstd >/dev/null 2>&1
    echo "✅ zstd installed."
else
    echo "✅ zstd already installed."
fi

if ! command -v pv &> /dev/null; then
    echo "⚠️  pv not found. Installing..."
    apt-get update -qq >/dev/null 2>&1
    apt-get install -y pv >/dev/null 2>&1
    echo "✅ pv installed."
else
    echo "✅ pv already installed."
fi

if ! command -v wget &> /dev/null; then
    echo "⚠️  wget not found. Installing..."
    apt-get update -qq >/dev/null 2>&1
    apt-get install -y wget >/dev/null 2>&1
    echo "✅ wget installed."
else
    echo "✅ wget already installed."
fi

if ! command -v lz4 &> /dev/null; then
    echo "⚠️  lz4 not found. Installing..."
    apt-get update -qq >/dev/null 2>&1
    apt-get install -y lz4 >/dev/null 2>&1
    echo "✅ lz4 installed."
else
    echo "✅ lz4 already installed."
fi
echo ""

# 2️⃣ Create directories
echo "→ Creating directories..."
mkdir -p "$EXECUTION_DIR" "$CONSENSUS_DIR"
echo "✅ Directories created."
echo ""

# 3️⃣ Generate JWT secret
echo "→ Generating JWT secret..."
openssl rand -hex 32 > "$JWT_FILE"
echo "✅ JWT secret generated."
echo ""

# 4️⃣ Stream download & extract snapshot directly (no temp file)
# Check if snapshot already exists
if [ -d "$EXECUTION_DIR/database" ] && [ "$(ls -A $EXECUTION_DIR/database/*.sst 2>/dev/null | wc -l)" -gt 0 ]; then
    echo "→ Snapshot already extracted, skipping download..."
    echo "   Database found at: $EXECUTION_DIR/database"
else
    echo "→ Downloading & extracting Besu snapshot (this will take a while)..."
    echo "   Target directory: $EXECUTION_DIR"
    echo "   Snapshot: block 9540000"
    cd "$EXECUTION_DIR"
    
    # Stream: download -> progress -> decompress -> extract (never saves compressed file)
    wget -q -O - "$BESU_SNAPSHOT_URL" | \
      pv | \
      zstd -d -T0 | \
      tar -xf - -C "$EXECUTION_DIR"
    
    if [ $? -ne 0 ]; then
        echo ""
        echo "❌ ERROR: Snapshot download/extraction failed!"
        echo "   Please check your internet connection and try again."
        exit 1
    fi
    
echo ""
echo "✅ Besu snapshot downloaded and extracted (compressed file not saved)."
echo ""
fi

# 4.5: Download & extract Prysm snapshot (optional - faster sync)
if [ -d "$CONSENSUS_DIR/beaconchaindata" ] && [ -f "$CONSENSUS_DIR/beaconchaindata/beaconchain.db" ]; then
    echo "→ Prysm database already exists, skipping snapshot download..."
else
    echo "→ Downloading & extracting Prysm snapshot (optional but faster)..."
    echo "   Target directory: $CONSENSUS_DIR"
    echo "   Snapshot: slot 8865077 (closer to current head = less forkchoice errors)"
    cd "$CONSENSUS_DIR"
    
    # Stream: download -> progress -> decompress -> extract (never saves compressed file)
    wget -q -O - "$PRYSM_SNAPSHOT_URL" | \
      pv | \
      lz4 -d | \
      tar -xf -
    
    if [ $? -ne 0 ]; then
        echo ""
        echo "⚠️  Prysm snapshot download failed (will use checkpoint sync instead)"
    else
        echo ""
        echo "✅ Prysm snapshot downloaded and extracted (compressed file not saved)."
    fi
    echo ""
fi

# Re-enable exit on error for rest of script
set -e

# Verify extraction completed
echo "→ Verifying snapshot extraction..."
if [ -d "$EXECUTION_DIR/database" ] && [ "$(ls -A $EXECUTION_DIR/database/*.sst 2>/dev/null | wc -l)" -gt 0 ]; then
    echo "✅ Database directory found with data files"
    echo "   Disk usage: $(du -sh $EXECUTION_DIR 2>/dev/null | cut -f1)"
else
    echo "⚠️  WARNING: Database directory missing or empty!"
    echo "   Snapshot extraction may have failed. Check logs above."
    exit 1
fi
echo ""

# 5️⃣ Create docker-compose.yml
echo "→ Creating docker-compose.yml..."
cat > "$DOCKER_COMPOSE_FILE" << 'EOF'
services:
  besu:
    image: hyperledger/besu:25.10.0
    container_name: besu
    network_mode: host
    restart: unless-stopped
    ports:
      - 30303:30303
      - 30303:30303/udp
      - 8545:8545
      - 8546:8546
      - 8551:8551
    volumes:
      - /root/ethereum/execution:/data
      - /root/ethereum/jwt.hex:/data/jwt.hex
    command:
      - --network=sepolia
      - --data-path=/data
      - --data-storage-format=BONSAI
      - --sync-mode=SNAP
      - --snapsync-server-enabled
      - --history-expiry-prune
      - --bonsai-limit-trie-logs-enabled=true
      - --bonsai-historical-block-limit=32768
      - --rpc-http-enabled=true
      - --rpc-http-host=0.0.0.0
      - --rpc-http-port=8545
      - --rpc-http-api=ETH,NET,WEB3
      - --rpc-http-cors-origins=*
      - --host-allowlist=*
      - --rpc-http-max-active-connections=500
      - --rpc-http-max-request-content-length=52428800
      - --engine-rpc-enabled=true
      - --engine-host-allowlist=*
      - --engine-jwt-secret=/data/jwt.hex
      - --engine-rpc-port=8551
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  prysm:
    image: gcr.io/offchainlabs/prysm/beacon-chain:v6.1.4
    container_name: prysm
    network_mode: host
    restart: unless-stopped
    depends_on:
      - besu
    ports:
      - 4000:4000
      - 3500:3500
    volumes:
      - /root/ethereum/consensus:/data
      - /root/ethereum/jwt.hex:/data/jwt.hex
    command:
      - --sepolia
      - --execution-endpoint=http://127.0.0.1:8551
      - --engine-endpoint-timeout-seconds=60
      - --jwt-secret=/data/jwt.hex
      - --checkpoint-sync-url=https://sepolia.beaconstate.info
      - --genesis-beacon-api-url=https://sepolia.beaconstate.info
      - --accept-terms-of-use
      - --datadir=/data
      - --rpc-host=0.0.0.0
      - --rpc-port=4000
      - --grpc-gateway-corsdomain=*
      - --grpc-gateway-host=0.0.0.0
      - --grpc-gateway-port=3500
      - --monitoring-port=8081
      - --disable-monitoring
      - --subscribe-all-data-subnets
      - --beacon-db-pruning
      - --pruner-retention-epochs=8192
      - --enable-backfill
      - --backfill-worker-count=2
      - --backfill-batch-size=32
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
EOF

echo "✅ docker-compose.yml created."
echo ""

# 6️⃣ Start node
echo "→ Starting Docker containers..."
cd "$ETHEREUM_DIR"
docker compose up -d
echo "✅ Containers started."
echo ""

# 7️⃣ Firewall setup
echo "→ Configuring firewall..."
ufw allow 22 >/dev/null 2>&1 || true
ufw allow ssh >/dev/null 2>&1 || true
ufw allow 30303/tcp >/dev/null 2>&1 || true
ufw allow 30303/udp >/dev/null 2>&1 || true
ufw allow 13000/tcp >/dev/null 2>&1 || true
ufw allow 12000/udp >/dev/null 2>&1 || true
ufw allow from 127.0.0.1 to any port 8545 proto tcp >/dev/null 2>&1 || true
ufw allow from 127.0.0.1 to any port 3500 proto tcp >/dev/null 2>&1 || true
ufw deny 8545/tcp >/dev/null 2>&1 || true
ufw deny 3500/tcp >/dev/null 2>&1 || true
echo "y" | ufw enable >/dev/null 2>&1 || true
echo "✅ Firewall configured."
echo ""

echo ""
echo "=========================================="
echo "✅ Setup Complete — Node Running"
echo "=========================================="
echo "Besu & Prysm started via Docker."
echo "Snapshot extracted directly to $EXECUTION_DIR"
echo "Firewall configured with safe defaults."
echo ""
echo "Check logs:"
echo "  docker compose logs -f"
echo ""
echo "Check sync status:"
echo "  curl -X POST -H 'Content-Type: application/json' --data '{\"jsonrpc\":\"2.0\",\"method\":\"eth_syncing\",\"params\":[],\"id\":1}' http://localhost:8545"
echo "  curl http://localhost:3500/eth/v1/node/syncing"
echo ""
